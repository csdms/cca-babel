<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2002-2-1 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Writing the C++ Implementation</TITLE>
<META NAME="description" CONTENT="Writing the C++ Implementation">
<META NAME="keywords" CONTENT="users_guide">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META NAME="Generator" CONTENT="LaTeX2HTML v2002-2-1">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="users_guide.css">

<LINK REL="next" HREF="node45.html">
<LINK REL="previous" HREF="node43.html">
<LINK REL="up" HREF="node43.html">
<LINK REL="next" HREF="node45.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A NAME="tex2html1494"
  HREF="node45.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html1488"
  HREF="node43.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html1482"
  HREF="node43.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html1490"
  HREF="node14.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html1492"
  HREF="node475.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html1495"
  HREF="node45.html">Writing the Fortran&nbsp;90 Implementation</A>
<B> Up:</B> <A NAME="tex2html1489"
  HREF="node43.html">Minimal Makefiles</A>
<B> Previous:</B> <A NAME="tex2html1483"
  HREF="node43.html">Minimal Makefiles</A>
 &nbsp; <B>  <A NAME="tex2html1491"
  HREF="node14.html">Contents</A></B> 
 &nbsp; <B>  <A NAME="tex2html1493"
  HREF="node475.html">Index</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->

<H2><A NAME="SECTION02321000000000000000"></A><A NAME="1817"></A>
<BR>
Writing the C++ Implementation
</H2>

<P>
We will write the C++ implementation in the minimal/libCxx/ subdirectory of hello/.  
The first step is to run the Babel code generator on the SIDL file and have
it generate the appropriate code.<A NAME="1818"></A> 
The simplified command to generate the Babel library code (assuming Babel is in 
your PATH) is <A NAME="tex2html24"
  HREF="footnode.html#foot1962"><SUP><SPAN CLASS="arabic">5</SPAN>.<SPAN CLASS="arabic">1</SPAN></SUP></A>: 

<P>
<BLOCKQUOTE>
<TT> <TT>%</TT> <TT><B>cd minimal/libCxx</B></TT>
<BR><TT>%</TT> <TT><B>babel -sC++ -makefile ../../hello.sidl</B></TT>
<BR>
</TT></BLOCKQUOTE>
<P>
In this Babel command, the ``<TT>-sC++</TT>'' flag, or its long form 
``<TT>-server=C++</TT>'', indicates that we wish to generate C++
bindings for an implementation<A NAME="tex2html25"
  HREF="footnode.html#foot1968"><SUP><SPAN CLASS="arabic">5</SPAN>.<SPAN CLASS="arabic">2</SPAN></SUP></A>.  
This command will generate a large number of C and C++ header 
and source files.  It is often surprising to newcomers just how
much code is generated by Babel. Rest assured, each file
has a purpose and there is a lot of important things being
done as efficiently as possible under the hood.

<P>
Files are named after the fully-qualified
class-name.  For instance, a package <TT><I CLASS="slanted">Hello</I></TT> and class
<TT><I CLASS="slanted">World</I></TT> would have a fully qualified name (in SIDL) as
<TT><I CLASS="slanted">Hello.World</I></TT>.  This corresponds to file names
beginning with <TT>Hello_World</TT><A NAME="tex2html26"
  HREF="footnode.html#foot1831"><SUP><SPAN CLASS="arabic">5</SPAN>.<SPAN CLASS="arabic">3</SPAN></SUP></A>.  For each class, 
there will be files with <TT>_IOR</TT>, 
<TT>_Skel</TT>, or <TT>_Impl</TT> appended after the
fully qualified name.  
Stubs often go without the <TT>_Stub</TT> suffix.
<SPAN  CLASS="textit">IOR files</SPAN><A NAME="1837"></A> are always in ANSI C (source and headers), 
containing Babel's Intermediate Object Representation.
<SPAN  CLASS="textit">Impl files</SPAN><A NAME="1839"></A> contain the actual implementation, and 
can be in any language that Babel supports, in this 
case, they're C++ files.  Impl files are the only files
that a developer need look at or touch after generating
code from the SIDL source.  
<SPAN  CLASS="textit">Skel files</SPAN><A NAME="1841"></A> perform translations
between the IORs and the Impls.  
In some cases (like Fortran)
the Skels are split into a few files: some in C, some in 
the Impl language.  
In the case of C++, the Skels are pure
C++ code wrapped in <TT>extern "C" {}</TT> declarations.
If the file is neither an IOR, Skel, nor Impl, then it
is likely a <SPAN  CLASS="textit">Stub</SPAN><A NAME="1844"></A>.  Stubs are the proxy classes
of Babel, performing translations
between the caller language and the IOR.  
Finally, the file <TT>babel.make</TT> is a Makefile fragment that is used by
<TT>GNUmakefile</TT> or to simplify making your own custom build.
You may ignore the babel.make file if you wish.  
There are also babel.make.depends and babel.make.package files.
These were added by external contributors, and we will ignore
them in this document.

<P>
The only files that should be modified by the developer
(that's you since you're implementing Hello World)
are the ``Impls'', which are in this case
files ending with <TT>_Impl.hxx</TT> or <TT>_Impl.cxx</TT>
Babel generates these implementation files as a starting 
point for developers.  
These files will contain the implementation of the Hello library.
Every implementation file contains many pairs of comment ``splicer''
lines<A NAME="1849"></A> 
such lines 4 and 6 in the following sample:

<P>
<BR>
<PRE  CLASS="verbatim">   1 ::std::string
   2 Hello::World_impl::getMsg_impl () 
   3 {
   4   // DO-NOT-DELETE splicer.begin(Hello.World.getMsg)
   5   // Insert-Code-Here {Hello.World.getMsg} (getMsg method)
   6   // DO-NOT-DELETE splicer.end(Hello.World.getMsg)
   7 }
</PRE></td></tr></table></blockquote>
<P>
Any modifications between these splicer lines will be
saved after subsequent invocations of the Babel tool.  
Any changes outside the splicer lines will be lost.  
This splicer feature was developed to make it
easy to do incremental development using Babel.
By keeping your edits within the splicer blocks, 
you can add new methods to the hello.sidl file
and rerun Babel without the loss of your previous 
method implementations.  You shouldn't ever need to edit the file
outside the splicer blocks.

<P>
For our hello application, the implementation is trivial.  
Add the following return statement between the splicer lines 
in the <TT>lib/Hello_World_Impl.cxx</TT> file:

<P>
<BR>
<PRE  CLASS="verbatim">::std::string
Hello::World_impl::getMsg_impl () 
{
  // DO-NOT-DELETE splicer.begin(Hello.World.getMsg)
  return "Hello from C++!";
  // DO-NOT-DELETE splicer.end(Hello.World.getMsg)
}
</PRE></td></tr></table></blockquote>
<P>
The following is a listing of the generated GNUmakefile
<A NAME="1853"></A> excluding the boilerplate copyright
notice.  It uses some of the tools installed along with Babel to
automated generating a static and shared library provided that the
machine supports both. The <TT>babel-config</TT> provides information
about which compilers and compiler flags to use, and
<TT>babel-libtool</TT> manages the building of object files and
libraries.

<P>
<BR>
<PRE  CLASS="verbatim">   1 include babel.make
   2 # please name the server library here
   3 LIBNAME=hello
   4 # please name the SIDL file here
   5 SIDLFILE=../../hello.sidl
   6 # extra include/compile flags 
   7 EXTRAFLAGS=
   8 # extra librarys that the implementation needs to link against
   9 EXTRALIBS=
  10 # library version number
  11 VERSION=0.1.1
  12 # PREFIX specifies the top of the installation directory
  13 PREFIX=/usr/local
  14 # the default installation installs the .la and .scl (if any) into the
  15 # LIBDIR
  16 LIBDIR=$(PREFIX)/lib
  17 # the default installation installs the stub header and IOR header files
  18 # in INCLDIR
  19 INCLDIR=$(PREFIX)/include
  20 
  21 # most of the rest of the file should not require editing
  22 
  23 ifeq ($(IMPLSRCS),)
  24   SCLFILE=
  25   BABELFLAG=--client=cxx
  26   MODFLAG=
  27 else
  28   SCLFILE=lib$(LIBNAME).scl
  29   BABELFLAG=--server=cxx
  30   MODFLAG=-module
  31 endif
  32 
  33 all : lib$(LIBNAME).la $(SCLFILE)
  34 
  35 CC=`babel-config --query-var=CC`
  36 CXX=`babel-config --query-var=CXX`
  37 INCLUDES=`babel-config --includes-cxx`
  38 CFLAGS=`babel-config --flags-c`
  39 CXXFLAGS=`babel-config --flags-cxx`
  40 LIBS=`babel-config --libs-cxx-client`
  41 
  42 STUBOBJS=$(STUBSRCS:.cxx=.lo)
  43 IOROBJS=$(IORSRCS:.c=.lo)
  44 SKELOBJS=$(SKELSRCS:.cxx=.lo)
  45 IMPLOBJS=$(IMPLSRCS:.cxx=.lo)
  46 
  47 PUREBABELGEN=$(IORHDRS) $(IORSRCS) $(STUBSRCS) $(STUBHDRS) $(SKELSRCS)
  48 BABELGEN=$(IMPLHDRS) $(IMPLSRCS)
  49 
  50 $(IMPLOBJS) : $(STUBHDRS) $(IORHDRS) $(IMPLHDRS)
  51 
  52 lib$(LIBNAME).la : $(STUBOBJS) $(IOROBJS) $(IMPLOBJS) $(SKELOBJS)
  53 	babel-libtool --mode=link --tag=CXX $(CXX) -o lib$(LIBNAME).la \
  54 	  -rpath $(LIBDIR) -release $(VERSION) \
  55 	  -no-undefined $(MODFLAG) \
  56 	  $(CXXFLAGS) $(EXTRAFLAGS) $^ $(LIBS) \
  57 	  $(EXTRALIBS)
  58 
  59 $(PUREBABELGEN) $(BABELGEN) : babel-stamp
  60 	@if test -f $@; then \
  61 	    touch $@; \
  62 	else \
  63 	    rm -f babel-stamp ; \
  64 	    $(MAKE) babel-stamp; \
  65 	fi
  66 
  67 babel-stamp: $(SIDLFILE)
  68 	@rm -f babel-temp
  69 	@touch babel-temp
  70 	babel $(BABELFLAG) $(SIDLFILE) 
  71 	@mv -f babel-temp $@
  72 
  73 lib$(LIBNAME).scl : $(IORSRCS)
  74 ifeq ($(IORSRCS),)
  75 	echo "lib$(LIBNAME).scl is not needed for client-side C bindings."
  76 else
  77 	-rm -f $@
  78 	echo '&lt;?xml version="1.0" ?&gt;' &gt; $@
  79 	echo '&lt;scl&gt;' &gt;&gt; $@	
  80 	if test `uname` = "Darwin"; then scope="global"; else scope="local"; \
  81 	   fi ; \
  82           echo ' &lt;library uri="'`pwd`/lib$(LIBNAME).la'" scope="'"$$scope"'" resolution="lazy" &gt;' &gt;&gt; $@
  83 	grep __set_epv $^ /dev/null | awk 'BEGIN {FS=":"} { print $$1}' | sort -u | sed -e 's/_IOR.c//g' -e 's/_/./g' | awk ' { printf "    &lt;class name=\"%s\" desc=\"ior/impl\" /&gt;\n", $$1 }' &gt;&gt;$@
  84 	echo "  &lt;/library&gt;" &gt;&gt;$@
  85 	echo "&lt;/scl&gt;" &gt;&gt;$@
  86 endif
  87 
  88 .SUFFIXES: .lo .cxx .c
  89 
  90 .c.lo:
  91 	babel-libtool --mode=compile --tag=CC $(CC) $(INCLUDES) $(CFLAGS) $(EXTRAFLAGS) -c -o $@ $&lt;
  92 
  93 .cxx.lo:
  94 	babel-libtool --mode=compile --tag=CXX $(CXX) $(INCLUDES) $(CXXFLAGS) $(EXTRAFLAGS) -c -o $@ $&lt;
  95 
  96 clean : 
  97 	-rm -f $(PUREBABELGEN) babel-temp babel-stamp *.o *.lo
  98 
  99 realclean : clean
 100 	-rm -f lib$(LIBNAME).la lib$(LIBNAME).scl
 101 	-rm -rf .libs
 102 
 103 install : install-libs install-headers install-scl
 104 
 105 
 106 install-libs : lib$(LIBNAME).la
 107 	-mkdir -p $(LIBDIR)
 108 	babel-libtool --mode=install install -c lib$(LIBNAME).la \
 109 	  $(LIBDIR)/lib$(LIBNAME).la
 110 
 111 install-scl : $(SCLFILE)
 112 ifneq ($(IORSRCS),)
 113 	-rm -f $(LIBDIR)/lib$(LIBNAME).scl
 114 	-mkdir -p $(LIBDIR)
 115 	echo '&lt;?xml version="1.0" ?&gt;' &gt; $(LIBDIR)/lib$(LIBNAME).scl
 116 	echo '&lt;scl&gt;' &gt;&gt; $(LIBDIR)/lib$(LIBNAME).scl	
 117 	if test `uname` = "Darwin"; then scope="global"; else scope="local"; \
 118 	   fi ; \
 119           echo ' &lt;library uri="'$(LIBDIR)/lib$(LIBNAME).la'" scope="'"$$scope"'" resolution="lazy" &gt;' &gt;&gt; $(LIBDIR)/lib$(LIBNAME).scl
 120 	grep __set_epv $^ /dev/null | awk 'BEGIN {FS=":"} { print $$1}' | sort -u | sed -e 's/_IOR.c//g' -e 's/_/./g' | awk ' { printf "    &lt;class name=\"%s\" desc=\"ior/impl\" /&gt;\n", $$1 }' &gt;&gt;$(LIBDIR)/lib$(LIBNAME).scl
 121 	echo "  &lt;/library&gt;" &gt;&gt;$(LIBDIR)/lib$(LIBNAME).scl
 122 	echo "&lt;/scl&gt;" &gt;&gt;$(LIBDIR)/lib$(LIBNAME).scl
 123 endif
 124 
 125 install-headers : $(IORHDRS) $(STUBHDRS)
 126 	-mkdir -p $(INCLDIR)
 127 	for i in $^ ; do \
 128 	  babel-libtool --mode=install cp $$i $(INCLDIR)/$$i ; \
 129 	done
 130 
 131 .PHONY: all clean realclean install install-libs install-headers install-scl
</PRE></td></tr></table></blockquote>
<P>
The details of this makefile deserve careful explanation.<DL>
<DT><STRONG>line 1:</STRONG></DT>
<DD><TT>babel.make</TT> is a file that Babel generates when it
  generates code.  It defines some standard names so our makefiles
  don't have to know every SIDL type declared in the file.
</DD>
<DT><STRONG>line 3:</STRONG></DT>
<DD><TT>LIBNAME</TT> defines the name of the library file
  that will be generated. <EM>This is the only line that I had to
  edit in the babel-generated GNUmakefile.</EM>
</DD>
<DT><STRONG>line 7:</STRONG></DT>
<DD>Use <TT>EXTRAFLAGS</TT> to define additional compile flags
  to be used when compiling files. For this example, it should be empty.
</DD>
<DT><STRONG>line 9:</STRONG></DT>
<DD><TT>EXTRALIBS</TT> should hold any extra libraries
  needed for your application. For this example, it should be empty.
</DD>
<DT><STRONG>line 11:</STRONG></DT>
<DD>The <TT>VERSION</TT> should be three numbers separated
  by periods.
</DD>
<DT><STRONG>line 13:</STRONG></DT>
<DD>The <TT>PREFIX</TT> is for libraries that will be
  installed.
</DD>
<DT><STRONG>line 21-end:</STRONG></DT>
<DD>This part of the <TT>GNUmakefile</TT> works from
  the definitions above and usually does not require changes unless
  you are incorporating it into a more complex build system.
</DD>
<DT><STRONG>line 33:</STRONG></DT>
<DD>The first build target in a Makefile is also the default target.
  Common convention is to make this target's name ``all.''
</DD>
<DT><STRONG>lines 35-40:</STRONG></DT>
<DD>Note that we use a script called <TT>babel-config</TT> to
  hand us some information.  This tool is very useful for getting the same
  information that Babel's configure script was given as Babel configuring
  itself.
  Increasingly, it is being used to also get information about tools and 
  flags used in Babel's makefiles, and its utility for getting at this level
  of information is limited...mostly because we rely on a multilayered stack
  of tools and some are less forthcoming than others.
</DD>
<DT><STRONG>lines 42-45:</STRONG></DT>
<DD>Here you see some of the variables defined in <TT>babel.make</TT>
  and some fancy suffix substitution to define <TT>STUBOBJS</TT>,
  <TT>IOROBJS</TT>, <TT>SKELOBJS</TT>, and <TT>IMPLOBJS</TT>.
</DD>
<DT><STRONG>lines 53:</STRONG></DT>
<DD>This is the rule to combine the <TT>.o</TT> files into
  a static and dynamic library using <TT>babel-libtool</TT>.
</DD>
<DT><STRONG>line 88:</STRONG></DT>
<DD>This is a often misunderstood detail.  To override the default
  suffix rules, one must give the list of new suffices to consider.
</DD>
<DT><STRONG>line 90-94:</STRONG></DT>
<DD>Here we start to override make's default suffix rules for
  converting C and C++ sourcecode into <TT>.o</TT> files.
</DD>
<DT><STRONG>lines 96 &amp; 99:</STRONG></DT>
<DD>How you go about various levels of cleanliness in your
  makefiles largely depends on matters of taste.  The important point here
  is what is <SPAN  CLASS="textit">not</SPAN> removed.  One thing not cleaned up is <TT>babel.make</TT>
  it is generated by Babel, but the makefile won't work without the file
  present because of the include in line 5.  Another important thing to 
  <SPAN  CLASS="textit">not</SPAN> remove is the Impl files, since they have hand-edited regions
  in the generated file.
</DD>
<DT><STRONG>line 103-129:</STRONG></DT>
<DD>Here we define some simple rules for installing
  libraries into standard system locations.
</DD>
<DT><STRONG>line 131:</STRONG></DT>
<DD>Technically, any phony targets like ``clean'' and ``new'' are
  supposed to be listed in this variable.  Many makefile implementations will
  work well if you skip this line, but.
</DD>
</DL>

<P>
With the GNUmakefile in place we can simply go to that directory and build
everything by typing make.

<P>

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A NAME="tex2html1494"
  HREF="node45.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html1488"
  HREF="node43.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html1482"
  HREF="node43.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html1490"
  HREF="node14.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html1492"
  HREF="node475.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html1495"
  HREF="node45.html">Writing the Fortran&nbsp;90 Implementation</A>
<B> Up:</B> <A NAME="tex2html1489"
  HREF="node43.html">Minimal Makefiles</A>
<B> Previous:</B> <A NAME="tex2html1483"
  HREF="node43.html">Minimal Makefiles</A>
 &nbsp; <B>  <A NAME="tex2html1491"
  HREF="node14.html">Contents</A></B> 
 &nbsp; <B>  <A NAME="tex2html1493"
  HREF="node475.html">Index</A></B> </DIV>
<!--End of Navigation Panel-->
<ADDRESS>
<br><br>babel-1.4.0<br>users_guide Last Modified 2008-10-16<br><br><a href="http://www.llnl.gov/CASC/components">http://www.llnl.gov/CASC/components</a><br><a href="mailto:components@llnl.gov">components@llnl.gov</a>
</ADDRESS>
</BODY>
</HTML>
